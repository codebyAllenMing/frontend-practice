<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="./index.css" />
        <title>Document</title>
        <script>
            let bodyDom;
            let count = 0;
            let idMap = new Map();
            const maxCount = 10;
            document.addEventListener("DOMContentLoaded", () => {
                const circle = document.querySelector(".circle");
                bodyDom = document.body;
                circle.addEventListener("click", onClick);
            });

            const onClick = () => {
                console.log(count);
                if (count === maxCount) return;
                count++;
                let iDom = document.createElement("i");
                iDom.classList.add("particles");
                setAnimateCircle(iDom);
            };

            const setAnimateCircle = (iDom) => {
                const id = crypto.randomUUID();
                idMap.set(id, { count: 0 });
                for (let i = 1; i < 50; i++) {
                    // 進入回圈時遞增該批次的存活數
                    const stateInc = idMap.get(id);
                    if (stateInc) {
                        stateInc.count++;
                    }

                    const particles = iDom.cloneNode(true);

                    const randomX = (Math.random() - 0.5) * window.innerWidth;
                    const randomY = (Math.random() - 0.5) * window.innerHeight;
                    particles.style.setProperty("--X", randomX + "px");
                    particles.style.setProperty("--Y", randomY + "px");

                    const randomSize = Math.random() * 60 + 10;
                    particles.style.width = randomSize + "px";
                    particles.style.height = randomSize + "px";

                    const duration = Math.random() * 3 + 2;
                    particles.style.animation = `animate ${duration}s ease infinite`;

                    // 隨機 1~10 秒
                    const timeoutRandom = (Math.random() * 9 + 1) * duration;

                    bodyDom.appendChild(particles);

                    setTimeout(() => {
                        particles.remove();
                        const stateDec = idMap.get(id);
                        if (!stateDec) return;
                        stateDec.count--;
                        if (stateDec.count === 0) {
                            idMap.delete(id);
                            count--;
                        }
                    }, Math.random() * timeoutRandom * 1000);
                }
            };
        </script>
    </head>
    <body>
        <div class="circle"></div>
        <svg>
            <filter id="gooey">
                <feGaussianBlur in="SourceGraphic" stdDeviation="10" />
                <feColorMatrix
                    values="1 0 0 0 0
                            0 1 0 0 0
                            0 0 1 0 0
                            0 0 0 50 -10"
                />
            </filter>
        </svg>
    </body>
</html>
